- name: Build linux-catgirl-edition
        run: |
          useradd -m builduser
          chown -R builduser:builduser .
          printf 'builduser ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/builduser
          
          export WORKSPACE_PATH=$(pwd)          
          sudo -E -u builduser bash <<'EOF'
            set -e
            cd "$WORKSPACE_PATH"

            # 1. DOWNLOAD KERNEL & PATCHES
            echo "--> Downloading Kernel and Patches..."
            curl -L "https://git.kernel.org/torvalds/t/linux-6.19-rc8.tar.gz" -o linux-6.19-rc8.tar.gz
            curl -L "https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.19/all/0001-cachyos-base-all.patch" -o base.patch
            curl -L "https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.19/misc/dkms-clang.patch" -o dkms.patch

            # 2. EXTRACT AND RENAME
            echo "--> Extracting..."
            rm -rf src/
            mkdir -p src
            tar -xf linux-6.19-rc8.tar.gz -C src/
            ROOT_FOLDER=$(tar -tf linux-6.19-rc8.tar.gz | head -1 | cut -f1 -d"/")
            mv "src/$ROOT_FOLDER" src/linux-6.19.rc8

            # 3. APPLY PATCHES
            echo "--> Applying CachyOS patches..."
            cd src/linux-6.19.rc8
            patch -p1 < ../../base.patch
            patch -p1 < ../../dkms.patch

            # 4. CONFIGURE KERNEL (BTF DISABLED TO PREVENT CRASH)
            echo "--> Configuring Kernel..."
            make defconfig
            scripts/config -e BPF -e BPF_SYSCALL -e BPF_JIT -e BPF_JIT_ALWAYS_ON \
                           -d DEBUG_INFO_BTF -d DEBUG_INFO_BTF_FEATURES \
                           -e SCHED_CLASS_EXT -e BPF_EVENTS \
                           -e TCP_CONG_BBR3 -e DEFAULT_BBR3 \
                           --set-val HZ 1000 -e HZ_1000 \
                           -e LRU_GEN -e LRU_GEN_ENABLED
            
            make olddefconfig
            # Copy this config back so makepkg sees it
            cp .config ../../config
            cd ../..

            # 5. CONFIGURE PKGBUILD
            sed -i 's/^_major=.*/_major=6.19/' PKGBUILD
            sed -i 's/^_minor=.*/_minor=.rc8/' PKGBUILD
            sed -i '/^source=(/,/)/d' PKGBUILD
            echo 'source=("linux-6.19-rc8.tar.gz" "config")' >> PKGBUILD

            # Flags and Bypasses
            export _processor_opt="znver4"
            export _O3_opt="1"
            export _sched_ext="1"
            export _tcp_bbr3="1"
            
            sed -i 's|_makenconfig:=[^}]*}|_makenconfig:=no}|' PKGBUILD
            sed -i 's|interactive=y|interactive=n|g' PKGBUILD
            sed -i 's|_die "|true; #|g' PKGBUILD

            # 6. RUN MAKEPKG
            export TERM=dumb
            # -e: use existing src, -f: force
            makepkg -sef --noconfirm --skipchecksums
          EOF
