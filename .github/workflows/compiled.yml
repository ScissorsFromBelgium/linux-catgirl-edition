name: "Catgirl-Edition-BTF-Path-Fix"

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    name: Build and Package
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Maximize build space
        run: |
          rm -rf /usr/share/dotnet
          rm -rf /usr/local/lib/android
          rm -rf /opt/ghc

      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git zip bc cpio pahole python clang llvm lld sudo ncurses curl kmod rsync

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build linux-catgirl-edition
        run: |
          useradd -m builduser
          chown -R builduser:builduser .
          printf 'builduser ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/builduser
          
          sudo -u builduser bash <<'EOF'
            set -e
            
            # Download source and patches
            echo "--> Downloading Sources..."
            curl -L "https://git.kernel.org/torvalds/t/linux-6.19-rc8.tar.gz" -o linux-6.19-rc8.tar.gz
            curl -L "https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.19/all/0001-cachyos-base-all.patch" -o 0001-cachyos-base-all.patch
            curl -L "https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.19/misc/dkms-clang.patch" -o dkms-clang.patch
            
            # Update version in PKGBUILD
            echo "--> Patching PKGBUILD version..."
            sed -i 's/^_major=.*/_major=6.19/' PKGBUILD
            sed -i 's/^_minor=.*/_minor=.rc8/' PKGBUILD
            
            # Delete old source and checksum arrays
            sed -i '/^source=(/,/^)/d' PKGBUILD
            sed -i '/^b2sums=(/,/)/d' PKGBUILD
            
            # Add new source array
            cat >> PKGBUILD << 'PKGBUILD_EOF'
source=(
    "linux-6.19-rc8.tar.gz"
    "config"
    "0001-cachyos-base-all.patch"
    "dkms-clang.patch"
)
b2sums=("SKIP" "SKIP" "SKIP" "SKIP")
PKGBUILD_EOF
            
            # Set build options via environment variables
            export _localmodcfg=no
            export _makenconfig=no
            export _processor_opt=znver4
            export _tcp_bbr3=yes
            export _no_btf=no
            export _disable_debugging=no
            export TERM=dumb
            
            # Build
            echo "--> Starting Makepkg..."
            makepkg -sf --noconfirm --skipchecksums
            
            # Results
            echo "--> Final Package Size Check:"
            du -sh *.pkg.tar.zst || echo "Build failed to produce a package."
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-catgirl-6.19-znver4
          path: "*.pkg.tar.zst"
