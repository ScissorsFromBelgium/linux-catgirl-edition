name: "Catgirl Edition Extreme (znver4 + 6.19.rc8 + sched-ext)"

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    name: Build and Package
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Maximize build space
        run: |
          rm -rf /usr/share/dotnet
          rm -rf /usr/local/lib/android
          rm -rf /opt/ghc

      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git zip bc cpio pahole python clang llvm lld sudo ncurses curl

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build linux-catgirl-edition
        run: |
          useradd -m builduser
          chown -R builduser:builduser .
          printf 'builduser ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/builduser
          
          export WORKSPACE_PATH=$(pwd)          
          sudo -E -u builduser bash <<'EOF'
            set -e
            cd "$WORKSPACE_PATH"

            # 1. DOWNLOAD FROM GIT SNAPSHOT (Guaranteed to exist)
            echo "--> Downloading Kernel from Git..."
            # We use the snapshot link which is always valid for tags
            curl -L -C - --retry 5 "https://git.kernel.org/torvalds/t/linux-6.19-rc8.tar.gz" -o linux-6.19-rc8.tar.gz

            # 2. VALIDATE DOWNLOAD
            # If file is smaller than 10MB, it's an error page. Fail now.
            filesize=$(stat -c%s "linux-6.19-rc8.tar.gz")
            if (( filesize < 10000000 )); then
              echo "Error: Downloaded file is too small ($filesize bytes). Likely a 404."
              cat linux-6.19-rc8.tar.gz
              exit 1
            fi

            # 3. MANUALLY EXTRACT AND RENAME
            # We find out exactly what the folder is named inside the tarball
            echo "--> Detecting folder name..."
            ROOT_FOLDER=$(tar -tf linux-6.19-rc8.tar.gz | head -1 | cut -f1 -d"/")
            echo "--> Tarball contains folder: $ROOT_FOLDER"

            echo "--> Extracting..."
            mkdir -p src
            tar -xf linux-6.19-rc8.tar.gz -C src/
            
            # RENAME to match PKGBUILD expectation (linux-6.19.rc8)
            if [ "$ROOT_FOLDER" != "linux-6.19.rc8" ]; then
                echo "--> Renaming $ROOT_FOLDER to linux-6.19.rc8"
                mv "src/$ROOT_FOLDER" src/linux-6.19.rc8
            fi

            # 4. CONFIGURE PKGBUILD
            sed -i 's/^_major=.*/_major=6.19/' PKGBUILD
            sed -i 's/^_minor=.*/_minor=.rc8/' PKGBUILD

            # Point source to local file
            sed -i '/^source=(/,/)/d' PKGBUILD
            echo 'source=("linux-6.19-rc8.tar.gz")' >> PKGBUILD

            # 5. SET FLAGS & BYPASS
            export _processor_opt="znver4"
            export _O3_opt="1"
            export _preempt="full"
            export _tickrate="1000"
            export _lto_mode="thin"
            export _sched_ext="1"
            export _tcp_bbr3="1"
            export _unattended_make_prepare="yes"
            export _makenconfig="no"

            sed -i 's|_makenconfig:=[^}]*}|_makenconfig:=no}|' PKGBUILD
            sed -i 's|_micro_optimize:=[^}]*}|_micro_optimize:=no}|' PKGBUILD
            sed -i 's|interactive=y|interactive=n|g' PKGBUILD
            sed -i 's|_die "|true; #|g' PKGBUILD
            sed -i 's|_processor_opt:=[^}]*}|_processor_opt:=znver4}|' PKGBUILD
            sed -i 's|_cflags_O3:=[^}]*}|_cflags_O3:=yes}|' PKGBUILD
            sed -i 's|_use_llvm_lto:=[^}]*}|_use_llvm_lto:=thin}|' PKGBUILD
            sed -i 's|_cpusched:=[^}]*}|_cpusched:=bore}|' PKGBUILD

            # 6. INJECT KERNEL CONFIG
            sed -i '/prepare() {/a \
              cd linux-6.19.rc8 \
              scripts/config -e BPF \
              scripts/config -e BPF_SYSCALL \
              scripts/config -e BPF_JIT \
              scripts/config -e BPF_JIT_ALWAYS_ON \
              scripts/config -e DEBUG_INFO_BTF \
              scripts/config -e DEBUG_INFO_BTF_FEATURES \
              scripts/config -e SCHED_CLASS_EXT \
              scripts/config -e BPF_EVENTS \
              scripts/config --set-val HZ 1000 \
              scripts/config -e HZ_1000 \
              make olddefconfig \
              cd ..' PKGBUILD

            export TERM=dumb
            
            # 7. RUN MAKEPKG WITH NO EXTRACT (-e)
            makepkg -se --noconfirm --skipchecksums
          EOF

      - name: Prepare and Upload Artifacts
        run: |
          zip linux-catgirl-6.19-znver4.zip *.pkg.tar.zst
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-catgirl-extreme-znver4
          path: linux-catgirl-6.19-znver4.zip
