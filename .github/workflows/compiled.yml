name: Catgirl Edition Compiled (znver4)

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    name: Build and Package
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Maximize build space
        run: |
          # Cleaning up the pre-installed bloat to make room for kernel objects
          rm -rf /usr/share/dotnet
          rm -rf /usr/local/lib/android
          rm -rf /opt/ghc

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git zip bc cpio pahole python clang llvm lld sudo
          useradd -m builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          # Ensure builduser owns the checkout
          chown -R builduser:builduser $(pwd)

      - name: Build linux-catgirl-edition
        run: |
          # Capture the absolute path to avoid the "null directory" error
          export WORKSPACE_PATH=$(pwd)
          
          sudo -E -u builduser bash <<EOF
            set -e
            cd "$WORKSPACE_PATH"
            
            # Target Zen 4 optimizations
            # Note: This assumes your PKGBUILD uses the _processor_opt variable
            sed -i 's|: "\${_processor_opt:=.*}"|: "\${_processor_opt:=znver4}"|' PKGBUILD
            
            # CI/Silent Mode flags
            sed -i 's|: "\${_localmodcfg:=yes}"|: "\${_localmodcfg:=no}"|' PKGBUILD
            sed -i 's|: "\${_use_auto_optimization:=yes}"|: "\${_use_auto_optimization:=no}"|' PKGBUILD
            sed -i 's|: "\${_unattended_make_prepare:=no}"|: "\${_unattended_make_prepare:=yes}"|' PKGBUILD
            sed -i 's|: "\${_makenconfig:=yes}"|: "\${_makenconfig:=no}"|' PKGBUILD
            
            # The actual compilation
            # -s installs dependencies via pacman, -c cleans up temporary files
            makepkg -scf --noconfirm --skipchecksums
          EOF

      - name: Prepare and Upload Artifacts
        run: |
          # Only zip the resulting Arch packages
          zip linux-catgirl-znver4.zip *.pkg.tar.zst

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-catgirl-edition-znver4
          path: linux-catgirl-znver4.zip
