name: "Catgirl-Edition-BTF-Final-Fix"

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    name: Build and Package
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Maximize build space
        run: |
          rm -rf /usr/share/dotnet
          rm -rf /usr/local/lib/android
          rm -rf /opt/ghc

      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git zip bc cpio pahole python clang llvm lld sudo ncurses curl kmod rsync

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build linux-catgirl-edition
        run: |
          useradd -m builduser
          chown -R builduser:builduser .
          printf 'builduser ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/builduser
          
          export WORKSPACE_PATH=$(pwd)          
          sudo -E -u builduser bash <<'EOF'
            set -e
            cd "$WORKSPACE_PATH"

            # 1. DOWNLOAD
            echo "--> Downloading Sources..."
            curl -L "https://git.kernel.org/torvalds/t/linux-6.19-rc8.tar.gz" -o linux-6.19-rc8.tar.gz

            # 2. PATCH PKGBUILD
            echo "--> Patching PKGBUILD..."
            
            # Update Version
            sed -i 's/^_major=.*/_major=6.19/' PKGBUILD
            sed -i 's/^_minor=.*/_minor=.rc8/' PKGBUILD

            # Force settings
            sed -i 's/: "${_localmodcfg:=yes}"/: "${_localmodcfg:=no}"/' PKGBUILD
            sed -i 's/: "${_makenconfig:=yes}"/: "${_makenconfig:=no}"/' PKGBUILD
            sed -i 's/: "${_processor_opt:=x86-64}"/: "${_processor_opt:=znver4}"/' PKGBUILD
            
            # The "Nuclear" Config Injection: 
            # We insert our config requirements at the end of the prepare() function
            # so they override everything else.
            sed -i '/prepare() {/a \
              echo "--> Forcing BTF and BBR3 configs..." \
              scripts/config -e DEBUG_INFO -e DEBUG_INFO_BTF -e DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT \
                             -d DEBUG_INFO_REDUCED -d DEBUG_INFO_COMPRESSED -d DEBUG_INFO_SPLIT \
                             -e TCP_CONG_BBR3 -e DEFAULT_BBR3 \
                             --set-val HZ 1000 -e HZ_1000 \
                             -e BPF -e BPF_SYSCALL' PKGBUILD

            # Fix the modprobed.db check error
            sed -i 's/error "No modprobed.db data found"/echo "Skipping modprobed check"/' PKGBUILD

            # Source setup - cleaning it up to only what we need
            sed -i '/^source=(/,/)/d' PKGBUILD
            echo 'source=("linux-6.19-rc8.tar.gz")' >> PKGBUILD
            # Add dummy sha256sums to pass integrity check
            echo 'sha256sums=("SKIP")' >> PKGBUILD

            # 3. RUN MAKEPKG
            echo "--> Starting Makepkg..."
            export TERM=dumb
            # -s: install missing deps, -f: force build
            makepkg -sf --noconfirm

            # 4. SIZE CHECK
            echo "--> Final Package Size Check:"
            du -sh *.pkg.tar.zst || echo "No package found!"
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-catgirl-6.19-znver4
          path: "*.pkg.tar.zst"
