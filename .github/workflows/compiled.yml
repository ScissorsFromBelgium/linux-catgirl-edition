name: Catgirl Edition Compiledd

on:
  push:
    branches:
      - master

jobs:
  build:
    name: Build and Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Docker
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io
          sudo systemctl start docker

      - name: Build linux-catgirl-edition inside Arch Linux container
        run: |
          docker run --rm \
            -v "$PWD:/workspace" \
            archlinux:latest bash -c '
              set -e

              pacman -Syu --noconfirm
              pacman -S --noconfirm base-devel git zip bc cpio pahole python clang llvm lld sudo

              useradd -m builduser
              echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
              chown -R builduser:builduser /workspace

              sudo -u builduser bash <<EOF
                cd /workspace
                sed -i "s|: \"\\\${_localmodcfg:=yes}\"|: \"\\\${_localmodcfg:=no}\"|" PKGBUILD
                sed -i "s|: \"\\\${_processor_opt:=}\"|: \"\\\${_processor_opt:=ZNVER4}\"|" PKGBUILD
                sed -i "s|: \"\\\${_use_auto_optimization:=yes}\"|: \"\\\${_use_auto_optimization:=no}\"|" PKGBUILD
                sed -i "s|: \"\\\${_unattended_make_prepare:=no}\"|: \"\\\${_unattended_make_prepare:=yes}\"|" PKGBUILD
                sed -i "s|: \"\\\${_makenconfig:=yes}\"|: \"\\\${_makenconfig:=no}\"|" PKGBUILD
                sed -i "s|: \"\\\${_no_compressed_initramfs:=yes}\"|: \"\\\${_no_compressed_initramfs:=no}\"|" PKGBUILD
                makepkg -scf --cleanbuild --skipchecksums
              EOF
            '

      - name: Zip build output
        run: |
          zip -r linux-catgirl-edition.zip . \
            -x ".git/*" ".github/*" "README.md" "linux-[0-9]*.tar.xz"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-catgirl-edition-compiled
          path: linux-catgirl-edition.zip
