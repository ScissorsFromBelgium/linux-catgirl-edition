name: "Catgirl Edition Extreme (znver4 + sched-ext)"

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    name: Build and Package
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Maximize build space
        run: |
          rm -rf /usr/share/dotnet
          rm -rf /usr/local/lib/android
          rm -rf /opt/ghc

      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git zip bc cpio pahole python clang llvm lld sudo
          useradd -m builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builduser:builduser $(pwd)

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build linux-catgirl-edition
        run: |
          export WORKSPACE_PATH=$(pwd)          
          sudo -E -u builduser bash <<'EOF'
            set -e
            cd "$WORKSPACE_PATH"
            
            # --- OVERRIDE LOGIC ---
            # Instead of sed-ing variables, we prepend our choices to the prepare() function
            # This ensures they are set correctly regardless of defaults.
            
            sed -i '/prepare() {/a \
              _processor_opt="znver4"; \
              _O3_opt="1"; \
              _preempt="full"; \
              _tickrate="1000"; \
              _disable_stack_init="1"; \
              _disable_memory_init="1"; \
              _no_printk="1"; \
              _no_corruption_check="1"; \
              _no_bug="1"; \
              _no_coredump="1"; \
              _no_tracing="1"; \
              _no_paravirt="1"; \
              _no_modify_ldt="1"; \
              _no_sched_debug="1"; \
              _lto_mode="thin"; \
              _unwinder="guess"; \
              _trim_unused_headers="yes"; \
              _tcp_bbr3="1"; \
              _sched_ext="1"; \
              _no_32bit="0"; \
              _localmodcfg="no"; \
              _unattended_make_prepare="yes";' PKGBUILD

            # Final check to see the injection
            head -n 50 PKGBUILD | grep "_tickrate"
            
            makepkg -scf --noconfirm --skipchecksums
          EOF

      - name: Prepare and Upload Artifacts
        run: |
          zip linux-catgirl-extreme.zip *.pkg.tar.zst
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-catgirl-extreme-znver4
          path: linux-catgirl-extreme.zip
