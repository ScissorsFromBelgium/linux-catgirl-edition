name: "Catgirl Edition Extreme (znver4 + 6.19.rc8 + SCX)"

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    name: Build and Package
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Maximize build space
        run: |
          rm -rf /usr/share/dotnet
          rm -rf /usr/local/lib/android
          rm -rf /opt/ghc

      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git zip bc cpio pahole python clang llvm lld sudo ncurses curl

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build linux-catgirl-edition
        run: |
          useradd -m builduser
          chown -R builduser:builduser .
          printf 'builduser ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/builduser
          
          export WORKSPACE_PATH=$(pwd)          
          sudo -E -u builduser bash <<'EOF'
            set -e
            cd "$WORKSPACE_PATH"

            # 1. SET VERSION
            sed -i 's/^_major=.*/_major=6.19/' PKGBUILD
            sed -i 's/^_minor=.*/_minor=.rc8/' PKGBUILD

            # 2. SOURCE ARRAY SETUP
            sed -i '/^source=(/,/)/d' PKGBUILD
            echo 'source=("https://git.kernel.org/torvalds/t/linux-6.19-rc8.tar.gz")' >> PKGBUILD

            # 3. DOWNLOAD 6.19 PATCHES
            curl -LO https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.19/all/0001-cachyos-base-all.patch
            curl -LO https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.19/misc/dkms-clang.patch
            curl -LO https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.19/0003-bbr3.patch

            # 4. SURGERY ON THE PKGBUILD
            # Kill the interactive read
            sed -i 's|read -r _tickrate|#|g' PKGBUILD
            # Force the tickrate check to ALWAYS pass
            sed -i 's|error "The value .$_tickrate. is invalid.*"|echo "Tickrate forced to 1000Hz"|' PKGBUILD
            sed -i 's|exit 1||g' PKGBUILD # Remove exit commands that might be triggered by the check
            
            # 5. INJECT WORKSPACE FIXES
            sed -i '/prepare() {/a \
              echo "--- FINAL PREP ---" \
              EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "linux-6.19*" | head -n 1) \
              if [ "$EXTRACTED_DIR" != "./linux-6.19.rc8" ]; then \
                mv "$EXTRACTED_DIR" linux-6.19.rc8; \
              fi \
              cd linux-6.19.rc8 \
              make defconfig \
              cp .config ../config \
              scripts/config --set-val HZ 1000 \
              scripts/config -e HZ_1000 \
              scripts/config -d HZ_300 \
              scripts/config -d HZ_250 \
              scripts/config -e BPF_EVENTS \
              scripts/config -e KALLSYMS_ALL \
              scripts/config -e FUNCTION_TRACER \
              scripts/config -e FTRACE \
              scripts/config -e SCHED_DEBUG \
              scripts/config -e DEBUG_INFO_BTF \
              scripts/config -e DEBUG_INFO_BTF_FEATURES \
              scripts/config -e SCHED_CLASS_EXT \
              make olddefconfig \
              cd ..' PKGBUILD

            # 6. RUN BUILD
            export TERM=dumb
            # We skip the check but still provide a "valid" looking variable for the script logic
            _tickrate="1000" makepkg -scf --noconfirm --skipchecksums
          EOF

      - name: Prepare and Upload Artifacts
        run: |
          zip linux-catgirl-6.19-znver4.zip *.pkg.tar.zst
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-catgirl-extreme-znver4
          path: linux-catgirl-6.19-znver4.zip
